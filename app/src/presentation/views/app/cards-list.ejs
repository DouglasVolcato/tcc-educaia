<% deck.cards.forEach(function(card) { %>
  <article class="flashcard-item card border-0 shadow-sm" id="card-<%= card.id %>">
    <div class="card-body p-4 d-flex flex-column gap-3">
      <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
        <div>
          <h3 class="h5 fw-semibold mb-1">
            <%= card.question %>
          </h3>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <% card.tags.forEach(function(tag) { %>
              <span class="badge text-bg-light pill">
                <%= tag %>
              </span>
              <% }) %>
          </div>
          <span class="badge badge-difficulty <%= card.difficulty %>">
            <%= card.difficulty==='easy' ? 'Fácil' : card.difficulty==='medium' ? 'Média' : 'Difícil' %>
          </span>
        </div>
        <div class="text-secondary small text-lg-end">
          <p class="mb-1"><i class="bi bi-clock-history me-1"></i> Revisado em <%= new
              Date(card.lastReviewedAt).toLocaleDateString('pt-BR') %>
          </p>
        </div>
        <div class="text-secondary small text-lg-end">
          <p class="mb-1"><i class="bi bi-clock-history me-1"></i> Próxima revisão em <%= new
              Date(card.nextReviewDate).toLocaleDateString('pt-BR') %>
          </p>
        </div>
      </div>
      <div class="border rounded-4 bg-body-tertiary p-3">
        <button class="btn btn-primary btn-sm mb-2" type="button" data-action="toggle-answer"
          data-target="#card-answer-<%= deck.id %>-<%= card.id %>"
          aria-controls="card-answer-<%= deck.id %>-<%= card.id %>" aria-expanded="false">
          <span data-visible-label>
            <i class="bi bi-eye me-1"></i> Revelar resposta
          </span>
          <span class="d-none" data-hidden-label>
            <i class="bi bi-eye-slash me-1"></i> Ocultar resposta
          </span>
        </button>
        <div id="card-answer-<%= deck.id %>-<%= card.id %>" class="d-none">
          <p class="mb-0">
            <%= card.answer %>
          </p>
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal"
          data-bs-target="#editCardModal-<%= card.id %>">
          <i class="bi bi-pencil me-1"></i> Editar
        </button>
        <button class="btn btn-outline-danger btn-sm" type="button" data-bs-toggle="modal"
          data-bs-target="#deleteCardModal-<%= card.id %>">
          <i class="bi bi-trash me-1"></i> Remover
        </button>
        <% if (!card.isDue) { %>
          <div id="move-card-to-review-<%= card.id %>">
            <button class="btn btn-outline-primary btn-sm" type="button"
              hx-post="/api/decks/<%= deck.id %>/cards/<%= card.id %>/move-to-review"
              hx-target="#move-card-to-review-<%= card.id %>" hx-swap="outerHTML">
              <i class="bi bi-arrow-clockwise me-1"></i> Mover para revisão
            </button>
          </div>
          <% } else { %>
            <span class="badge text-bg-warning d-inline-flex align-items-center gap-1">
              <i class="bi bi-exclamation-triangle-fill"></i>
              Revisão pendente
            </span>
            <% } %>
      </div>
    </div>
  </article>

  <div class="modal fade" id="editCardModal-<%= card.id %>" tabindex="-1" aria-labelledby="editCardLabel-<%= card.id %>"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <form class="modal-content border-0 shadow" hx-put="/api/decks/<%= deck.id %>/cards/<%= card.id %>"
        hx-target="#global-alert-container" hx-swap="beforeend"
        hx-on::after-request="if(event.detail.xhr.status === 200) location.reload()">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="editCardLabel-<%= card.id %>">Editar carta</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body d-grid gap-3">
          <div>
            <label class="form-label fw-semibold" for="questionEdit-<%= card.id %>">Pergunta</label>
            <textarea class="form-control" id="questionEdit-<%= card.id %>" name="question" rows="3"
              required><%= card.question %></textarea>
          </div>
          <div>
            <label class="form-label fw-semibold" for="answerEdit-<%= card.id %>">Resposta</label>
            <textarea class="form-control" id="answerEdit-<%= card.id %>" name="answer" rows="4"
              required><%= card.answer %></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" data-loading-button>
            <span data-loading-label>Salvar alterações</span>
            <span class="d-none" data-loading-spinner>
              <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
              <span class="ms-2">Atualizando...</span>
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="deleteCardModal-<%= card.id %>" tabindex="-1"
    aria-labelledby="deleteCardLabel-<%= card.id %>" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content border-0 shadow" hx-delete="/api/decks/<%= deck.id %>/cards/<%= card.id %>"
        hx-target="#global-alert-container" hx-swap="beforeend"
        hx-on::after-request="if(event.detail.xhr.status === 200) document.getElementById('card-<%= card.id %>').remove(); document.getElementById('deleteCardModal-<%= card.id %>').querySelector('.btn-close').click();">
        <div class="modal-header">
          <div>
            <p class="text-secondary text-uppercase small mb-1">Confirmação</p>
            <h1 class="modal-title fs-5" id="deleteCardLabel-<%= card.id %>">Remover carta</h1>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Deseja remover a carta "<%= card.question %>"? Essa ação não pode ser desfeita.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger" data-loading-button>
            <span data-loading-label>Remover carta</span>
            <span class="d-none" data-loading-spinner>
              <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
              <span class="ms-2">Removendo...</span>
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <% }) %>