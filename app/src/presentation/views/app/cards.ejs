<%- include('../partials/head', { title }) %>
  <body>
    <div class="d-flex flex-column min-vh-100">
      <%- include('../partials/navbar', { active: 'decks', user, hideNavbar: false }) %>
      <main class="flex-grow-1">
        <div class="container d-flex flex-column gap-4">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/app/decks">Baralhos</a></li>
              <li class="breadcrumb-item active" aria-current="page"><%= deck.name %></li>
            </ol>
          </nav>

          <section class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4 p-md-5">
              <div class="row g-4 align-items-start">
                <div class="col-lg-8">
                  <div class="d-flex flex-column flex-md-row gap-3 align-items-md-center justify-content-between mb-3">
                    <div>
                      <span class="badge bg-primary-subtle text-primary pill mb-2"><%= deck.subject %></span>
                      <h1 class="h3 fw-bold mb-1"><%= deck.name %></h1>
                      <p class="text-secondary mb-0"><%= deck.description %></p>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                      <a class="btn btn-primary" href="/app/review">
                        <i class="bi bi-lightning-charge-fill me-2"></i> Começar revisão
                      </a>
                      <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createCardModal">
                        <i class="bi bi-magic me-2"></i> Nova carta
                      </button>
                      <button class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#deckSettings" aria-controls="deckSettings">
                        <i class="bi bi-sliders me-2"></i> Configurações
                      </button>
                    </div>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="bg-body-tertiary rounded-4 p-3 h-100">
                        <span class="text-secondary small text-uppercase">Cartas</span>
                        <p class="fs-4 fw-bold mb-0"><%= deck.totalCards %></p>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="bg-body-tertiary rounded-4 p-3 h-100">
                        <span class="text-secondary small text-uppercase">Para revisar</span>
                        <p class="fs-4 fw-bold mb-0 text-warning"><%= deck.dueCards %></p>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="bg-body-tertiary rounded-4 p-3 h-100">
                        <span class="text-secondary small text-uppercase">Progresso</span>
                        <div class="d-flex align-items-center gap-2">
                          <div class="progress flex-grow-1 progress-bar-rounded" role="progressbar" aria-valuenow="<%= deck.progress %>" aria-valuemin="0" aria-valuemax="100">
                            <div class="progress-bar bg-primary" style="width: <%= deck.progress %>%"></div>
                          </div>
                          <span class="fw-semibold"><%= deck.progress %>%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="border rounded-4 p-4 h-100 bg-light">
                    <h2 class="h6 text-uppercase text-secondary fw-semibold">Ações rápidas</h2>
                    <ul class="list-unstyled d-flex flex-column gap-3 mb-4">
                      <li class="d-flex align-items-start gap-3">
                        <i class="bi bi-magic text-primary fs-4"></i>
                        <div>
                          <p class="fw-semibold mb-1">Gerar novas cartas</p>
                          <p class="text-secondary small mb-0">Cole conteúdos, resumos ou artigos para transformar em flashcards automaticamente.</p>
                        </div>
                      </li>
                    </ul>
                    <a class="btn btn-primary w-100" href="/app/decks/<%= deck.id %>/import">
                      <i class="bi bi-plus-lg me-2"></i> Gerar cartas com IA
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="d-flex flex-column gap-3">
            <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 align-items-lg-center">
              <div>
                <h2 class="h4 fw-bold mb-1">Cartas do baralho</h2>
                <p class="text-secondary mb-0">Reveja e organize as cartas criadas manualmente ou com IA.</p>
              </div>
              <form class="d-flex flex-wrap gap-2" hx-get="/app/decks/<%= deck.id %>/filter-cards" hx-target="#cardsList" hx-swap="innerHTML" data-loading-overlay="false">
                <div class="input-group">
                  <span class="input-group-text bg-body-tertiary border-0"><i class="bi bi-search"></i></span>
                  <input class="form-control border-0" type="search" name="q" placeholder="Buscar por título, tag ou conteúdo" />
                </div>
                <select class="form-select" name="difficulty">
                  <option value="">Dificuldade</option>
                  <option value="easy">Fácil</option>
                  <option value="medium">Média</option>
                  <option value="hard">Difícil</option>
                </select>
                <button type="submit" class="btn btn-outline-secondary" data-loading-button>
                  <span data-loading-label>Filtrar</span>
                  <span class="d-none" data-loading-spinner>
                    <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
                    <span class="ms-2">Carregando...</span>
                  </span>
                </button>
              </form>
            </div>

            <div id="cardsList" class="d-flex flex-column gap-3">
              <% deck.cards.forEach(function(card) { %>
                <article class="flashcard-item card border-0 shadow-sm" id="card-<%= card.id %>">
                  <div class="card-body p-4 d-flex flex-column gap-3">
                    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
                      <div>
                        <h3 class="h5 fw-semibold mb-1"><%= card.question %></h3>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                          <% card.tags.forEach(function(tag) { %>
                            <span class="badge text-bg-light pill"><%= tag %></span>
                          <% }) %>
                        </div>
                        <span class="badge badge-difficulty <%= card.difficulty %>">
                          <%= card.difficulty === 'easy' ? 'Fácil' : card.difficulty === 'medium' ? 'Média' : 'Difícil' %>
                        </span>
                      </div>
                      <div class="text-secondary small text-lg-end">
                        <p class="mb-1"><i class="bi bi-clock-history me-1"></i> Revisado em <%= new Date(card.lastReviewedAt).toLocaleDateString('pt-BR') %></p>
                      </div>
                      <div class="text-secondary small text-lg-end">
                        <p class="mb-1"><i class="bi bi-clock-history me-1"></i> Próxima revisão em <%= new Date(card.nextReviewDate).toLocaleDateString('pt-BR') %></p>
                      </div>
                    </div>
                    <div class="border rounded-4 bg-body-tertiary p-3">
                      <button
                        class="btn btn-primary btn-sm mb-2"
                        type="button"
                        data-action="toggle-answer"
                        data-target="#card-answer-<%= deck.id %>-<%= card.id %>"
                        aria-controls="card-answer-<%= deck.id %>-<%= card.id %>"
                        aria-expanded="false"
                      >
                        <span data-visible-label>
                          <i class="bi bi-eye me-1"></i> Revelar resposta
                        </span>
                        <span class="d-none" data-hidden-label>
                          <i class="bi bi-eye-slash me-1"></i> Ocultar resposta
                        </span>
                      </button>
                      <div id="card-answer-<%= deck.id %>-<%= card.id %>" class="d-none">
                        <p class="mb-0"><%= card.answer %></p>
                      </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                      <button
                        class="btn btn-outline-secondary btn-sm"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#editCardModal"
                        data-card-id="<%= card.id %>"
                        data-card-question="<%= card.question.replace(/\"/g, '&quot;').replace(/\n/g, '&#10;') %>"
                        data-card-answer="<%= card.answer.replace(/\"/g, '&quot;').replace(/\n/g, '&#10;') %>"
                      >
                        <i class="bi bi-pencil me-1"></i> Editar
                      </button>
                      <button
                        class="btn btn-outline-danger btn-sm"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteCardModal"
                        data-card-id="<%= card.id %>"
                        data-card-question="<%= card.question.replace(/\"/g, '&quot;') %>"
                      >
                        <i class="bi bi-trash me-1"></i> Remover
                      </button>
                      <% if (!card.isDue) { %>
                        <div id="move-card-to-review-<%= card.id %>">
                          <button
                            class="btn btn-outline-primary btn-sm"
                            type="button"
                            hx-post="/api/decks/<%= deck.id %>/cards/<%= card.id %>/move-to-review"
                            hx-target="#move-card-to-review-<%= card.id %>"
                            hx-swap="outerHTML"
                          >
                            <i class="bi bi-arrow-clockwise me-1"></i> Mover para revisão
                          </button>
                        </div>
                      <% } else { %>
                        <span class="badge text-bg-warning d-inline-flex align-items-center gap-1">
                          <i class="bi bi-exclamation-triangle-fill"></i>
                          Revisão pendente
                        </span>
                      <% } %>
                    </div>
                  </div>
                </article>
              <% }) %>
            </div>
          </section>
        </div>
      </main>
      <%- include('../partials/footer') %>
    </div>

    <div class="modal fade" id="createCardModal" tabindex="-1" aria-labelledby="createCardLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="createCardLabel">Nova carta</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <form 
              class="d-grid gap-3" 
              hx-post="/api/decks/<%= deck.id %>/cards" 
              hx-target="#global-alert-container" 
              hx-swap="beforeend"
              hx-on::after-request="if(event.detail.xhr.status === 201) location.reload()"
            >
              <div>
                <label class="form-label fw-semibold" for="question">Pergunta</label>
                <textarea class="form-control" id="question" name="question" rows="3" required></textarea>
              </div>

              <div>
                <label class="form-label fw-semibold" for="answer">Resposta</label>
                <textarea class="form-control" id="answer" name="answer" rows="4" required></textarea>
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="difficulty">Dificuldade inicial</label>
                  <select class="form-select" id="difficulty" name="difficulty" required>
                    <option value="easy">Fácil</option>
                    <option value="medium">Média</option>
                    <option value="hard">Difícil</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="tags">Tags</label>
                  <input class="form-control" type="text" id="tags" name="tags" placeholder="ex.: álgebra, equações" />
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" data-loading-button>
                  <span data-loading-label>Adicionar carta</span>
                  <span class="d-none" data-loading-spinner>
                    <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
                    <span class="ms-2">Salvando...</span>
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editCardModal" tabindex="-1" aria-labelledby="editCardLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="editCardLabel">Editar carta</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <form class="d-grid gap-3" data-edit-card-form hx-target="#global-alert-container" hx-swap="beforeend">
              <div>
                <label class="form-label fw-semibold" for="questionEdit">Pergunta</label>
                <textarea class="form-control" id="questionEdit" name="question" rows="3"></textarea>
              </div>
              <div>
                <label class="form-label fw-semibold" for="answerEdit">Resposta</label>
                <textarea class="form-control" id="answerEdit" name="answer" rows="4"></textarea>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" data-loading-button>
                  <span data-loading-label>Salvar alterações</span>
                  <span class="d-none" data-loading-spinner>
                    <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
                    <span class="ms-2">Atualizando...</span>
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="deleteCardModal" tabindex="-1" aria-labelledby="deleteCardLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header">
            <div>
              <p class="text-secondary text-uppercase small mb-1">Confirmação</p>
              <h1 class="modal-title fs-5" id="deleteCardLabel">Remover carta</h1>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <p class="mb-0" id="deleteCardMessage">Tem certeza que deseja remover esta carta? Essa ação não pode ser desfeita.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button
              type="button"
              class="btn btn-danger"
              data-delete-card-confirm
              hx-target="#global-alert-container"
              hx-swap="beforeend"
            >
              Remover carta
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="deckSettings" aria-labelledby="deckSettingsLabel">
      <div class="offcanvas-header">
        <h5 id="deckSettingsLabel">Configurações do baralho</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      </div>
      <div class="offcanvas-body d-grid gap-3">
        <form 
          class="d-grid gap-3"
          style="grid-auto-rows: min-content;"
          hx-put="/api/decks/<%= deck.id %>"
          hx-on::after-request="if(event.detail.xhr.status === 200) location.reload()"
        >
          <div>
            <label class="form-label fw-semibold" for="deckNameEdit">Nome do baralho</label>
            <input class="form-control" type="text" id="deckNameEdit" name="name" value="<%= deck.name %>" required />
          </div>
          <div>
            <label class="form-label fw-semibold" for="deckSubject">Assunto</label>
            <input class="form-control" type="text" id="deckSubject" name="subject" value="<%= deck.subject %>" required />
          </div>
          <div>
            <label class="form-label fw-semibold" for="deckDescriptionEdit">Descrição</label>
            <textarea class="form-control" id="deckDescriptionEdit" name="description" rows="3"><%= deck.description %></textarea>
          </div>
          <div>
            <label class="form-label fw-semibold" for="deckTags">Tags</label>
            <input class="form-control" type="text" id="deckTags" name="tags" placeholder="Ex.: biologia, genética" value="<%= deck.tags.join(', ') %>" />
            <small class="text-secondary">Separe as tags por vírgula para facilitar a organização.</small>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Fechar</button>
            <button type="submit" class="btn btn-primary" data-loading-button>
              <span data-loading-label>Salvar alterações</span>
              <span class="d-none" data-loading-spinner>
                <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
                <span class="ms-2">Atualizando...</span>
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <%- include('../partials/feedback') %>
    <script>
      (() => {
        const editModal = document.getElementById('editCardModal');
        const editForm = editModal?.querySelector('[data-edit-card-form]');
        const editQuestion = document.getElementById('questionEdit');
        const editAnswer = document.getElementById('answerEdit');

        editModal?.addEventListener('show.bs.modal', (event) => {
          const trigger = event.relatedTarget;
          const cardId = trigger?.getAttribute('data-card-id') ?? '';
          const question = trigger?.getAttribute('data-card-question') ?? '';
          const answer = trigger?.getAttribute('data-card-answer') ?? '';

          editForm?.setAttribute('hx-put', `/api/decks/<%= deck.id %>/cards/${cardId}`);
          if (editForm) {
            htmx.process(editForm);
          }
          if (editForm) {
            editForm.dataset.cardId = cardId;
          }
          if (editQuestion) {
            editQuestion.value = question;
          }
          if (editAnswer) {
            editAnswer.value = answer;
          }
        });

        editForm?.addEventListener('htmx:afterRequest', (event) => {
          // @ts-ignore
          if (event.detail?.xhr?.status === 200) {
            const cardId = editForm.dataset.cardId;
            window.bootstrap?.Modal.getInstance(editModal)?.hide();
            if (cardId) {
              window.location.hash = `card-${cardId}`;
            }
            window.location.reload();
          }
        });

        const deleteModal = document.getElementById('deleteCardModal');
        const deleteMessage = document.getElementById('deleteCardMessage');
        const deleteConfirm = deleteModal?.querySelector('[data-delete-card-confirm]');

        deleteModal?.addEventListener('show.bs.modal', (event) => {
          const trigger = event.relatedTarget;
          const cardId = trigger?.getAttribute('data-card-id') ?? '';
          const question = trigger?.getAttribute('data-card-question') ?? '';

          deleteConfirm?.setAttribute('hx-delete', `/api/decks/<%= deck.id %>/cards/${cardId}`);
          if (deleteConfirm) {
            deleteConfirm.dataset.cardId = cardId;
            htmx.process(deleteConfirm);
          }
          if (deleteMessage) {
            deleteMessage.textContent = question
              ? `Deseja remover a carta "${question}"? Essa ação não pode ser desfeita.`
              : 'Tem certeza que deseja remover esta carta? Essa ação não pode ser desfeita.';
          }
        });

        deleteConfirm?.addEventListener('htmx:afterRequest', (event) => {
          // @ts-ignore
          if (event.detail?.xhr?.status === 200) {
            window.bootstrap?.Modal.getInstance(deleteModal)?.hide();
            window.location.reload();
          }
        });
      })();
    </script>
  <%- include('../partials/scripts') %>
