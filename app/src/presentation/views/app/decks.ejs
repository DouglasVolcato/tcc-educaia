<%- include('../partials/head', { title }) %>
  <body>
    <div class="d-flex flex-column min-vh-100">
      <%- include('../partials/navbar', { active: 'decks', user, hideNavbar: false }) %>
      <main class="flex-grow-1">
        <div class="container d-flex flex-column gap-4">
          <section class="card hero-card rounded-5 overflow-hidden">
            <div class="card-body p-4 p-md-5 d-flex flex-column flex-lg-row align-items-center gap-4">
              <div class="text-center text-lg-start">
                <p class="text-uppercase small mb-2 opacity-75">Ol√°, <%= user.name.split(' ')[0] %>! üëã</p>
                <h1 class="display-6 fw-bold mb-3">Pronto para sua pr√≥xima sess√£o de estudo?</h1>
                <p class="mb-4 opacity-75">
                  Voc√™ tem <strong><%= summary.dueToday %> flashcards</strong> esperando revis√£o hoje. Continue avan√ßando nos seus baralhos e alcance suas metas.
                </p>
                <div class="d-flex flex-column flex-sm-row gap-2">
                  <button
                    class="btn btn-light btn-lg"
                    data-bs-toggle="modal"
                    data-bs-target="#createDeckModal"
                  >
                    <i class="bi bi-plus-lg me-2"></i> Novo baralho
                  </button>
                  <a class="btn btn-outline-light btn-lg" href="/app/review">
                    <i class="bi bi-lightning-charge-fill me-2"></i> Iniciar revis√£o
                  </a>
                </div>
              </div>
              <div class="bg-white bg-opacity-10 rounded-4 p-4 w-100 w-lg-50">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <span class="text-uppercase small opacity-75">Resumo r√°pido</span>
                  <span class="badge bg-light text-primary pill">Atualizado agora</span>
                </div>
                <div class="row g-3 text-start">
                  <div class="col-6">
                    <div class="bg-white bg-opacity-10 rounded-4 p-3">
                      <span class="small text-uppercase opacity-75">Baralhos</span>
                      <p class="display-6 fw-bold mb-0"><%= summary.totalDecks %></p>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="bg-white bg-opacity-10 rounded-4 p-3">
                      <span class="small text-uppercase opacity-75">Cartas</span>
                      <p class="display-6 fw-bold mb-0"><%= summary.totalCards %></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="d-flex flex-column gap-3" id="deckListSection">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
              <div>
                <h2 class="h4 fw-bold mb-1">Meus baralhos</h2>
                <p class="text-secondary mb-0">Gerencie, revise e acompanhe o desempenho de cada baralho.</p>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <div class="btn-group" role="group" aria-label="Filtros de baralho">
                  <button
                    type="button"
                    class="btn btn-outline-primary <%= activeFilter === 'all' ? 'active' : '' %>"
                    hx-get="/app/decks?filter=all"
                    hx-target="#deckListSection"
                    hx-select="#deckListSection"
                    hx-swap="outerHTML"
                  >
                    Todos
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary <%= activeFilter === 'due' ? 'active' : '' %>"
                    hx-get="/app/decks?filter=due"
                    hx-target="#deckListSection"
                    hx-select="#deckListSection"
                    hx-swap="outerHTML"
                  >
                    Com revis√£o
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary <%= activeFilter === 'recent' ? 'active' : '' %>"
                    hx-get="/app/decks?filter=recent"
                    hx-target="#deckListSection"
                    hx-select="#deckListSection"
                    hx-swap="outerHTML"
                  >
                    Recentes
                  </button>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDeckModal">
                  <i class="bi bi-plus-lg me-2"></i> Novo baralho
                </button>
              </div>
            </div>

            <div id="decksGrid" class="row g-4">
              <% decks.forEach(function(deck) { %>
                <div id="deck-<%= deck.id %>" class="col-12 col-md-6 col-xl-4">
                  <article class="card deck-card border-0 h-100 shadow-sm">
                    <div class="card-body d-flex flex-column gap-3">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <h3 class="h5 fw-bold mb-1"><%= deck.name %></h3>
                          <p class="text-secondary small mb-2"><%= deck.subject %> ‚Ä¢ Atualizado em <%= new Date(deck.updatedAt).toLocaleDateString('pt-BR') %></p>
                        </div>
                        <span class="badge bg-primary-subtle text-primary pill"><%= deck.dueCards %> para revisar</span>
                      </div>
                      <p class="text-secondary mb-0"><%= deck.description %></p>
                      <div class="d-flex flex-wrap gap-2">
                        <% deck.tags.forEach(function(tag) { %>
                          <span class="badge text-bg-light pill"><%= tag %></span>
                        <% }) %>
                      </div>
                      <div>
                        <div class="d-flex justify-content-between small mb-1">
                          <span><%= deck.totalCards %> cartas</span>
                          <span><%= deck.progress %>% conclu√≠do</span>
                        </div>
                        <div class="progress progress-bar-rounded" role="progressbar" aria-valuenow="<%= deck.progress %>" aria-valuemin="0" aria-valuemax="100">
                          <div class="progress-bar bg-primary" style="width: <%= deck.progress %>%"></div>
                        </div>
                      </div>
                      <div class="d-flex flex-wrap gap-2">
                        <a class="btn btn-primary flex-grow-1" href="/app/decks/<%= deck.id %>/cards">
                          <i class="bi bi-collection me-2"></i> Abrir baralho
                        </a>
                        <button
                          class="btn btn-outline-danger"
                          type="button"
                          data-bs-toggle="modal"
                          data-bs-target="#deleteDeckModal-<%= deck.id %>"
                        >
                          <i class="bi bi-trash me-2"></i> Apagar baralho
                        </button>
                      </div>
                  <div class="d-flex justify-content-between align-items-center border-top pt-3">
                    <div class="d-flex align-items-center gap-3 text-secondary small">
                      <span><i class="bi bi-lightning-charge-fill text-warning me-1"></i> <%= deck.newCards %> novos</span>
                      <span><i class="bi bi-clock-history text-primary me-1"></i> √öltima revis√£o <%= deck.cards && deck.cards.length ? deck.cards[0].lastReviewedAt : '' %></span>
                    </div>
                        <button
                          class="btn btn-outline-secondary btn-sm"
                          type="button"
                          data-bs-toggle="dropdown"
                          aria-expanded="false"
                        >
                          <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                          <li><a class="dropdown-item" href="/app/decks/<%= deck.id %>/cards">Editar baralho</a></li>
                          <li><a class="dropdown-item" href="/app/decks/<%= deck.id %>/import">Gerar flashcards com IA</a></li>
                          <li><hr class="dropdown-divider" /></li>
                          <li>
                            <a
                              class="dropdown-item text-danger"
                              href="#"
                              data-bs-toggle="modal"
                              data-bs-target="#deleteDeckModal-<%= deck.id %>"
                            >
                        Excluir
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </article>

            <div class="modal fade" id="deleteDeckModal-<%= deck.id %>" tabindex="-1" aria-labelledby="deleteDeckLabel-<%= deck.id %>" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <form
                  class="modal-content border-0 shadow"
                  hx-delete="/api/decks/<%= deck.id %>"
                  hx-target="#global-alert-container"
                  hx-swap="beforeend"
                  hx-on::after-request="if(event.detail.xhr.status === 200) document.getElementById('deck-<%= deck.id %>').remove(); document.getElementById('deleteDeckModal-<%= deck.id %>').querySelector('.btn-close').click();"
                >
                  <div class="modal-header">
                    <div>
                      <p class="text-secondary text-uppercase small mb-1">Confirma√ß√£o</p>
                      <h1 class="modal-title fs-5" id="deleteDeckLabel-<%= deck.id %>">Apagar baralho</h1>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                  </div>
                  <div class="modal-body">
                    <p class="mb-0">Deseja remover o baralho "<%= deck.name %>" e todas as suas cartas?</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger" data-loading-button>
                      <span data-loading-label>Remover baralho</span>
                      <span class="d-none" data-loading-spinner>
                        <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
                        <span class="ms-2">Removendo...</span>
                      </span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
          </section>
        </div>
      </main>
      <%- include('../partials/footer') %>
    </div>

    <div class="modal fade" id="createDeckModal" tabindex="-1" aria-labelledby="createDeckModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="createDeckModalLabel">Criar novo baralho</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <form
              class="d-grid gap-3"
              hx-post="/api/decks"
              hx-target="#global-alert-container"
              hx-swap="beforeend"
              hx-on::after-request="
                if (event.detail.successful) {
                  const modalElement = document.getElementById('createDeckModal');
                  const modalInstance = window.bootstrap?.Modal.getInstance(modalElement);
                  modalInstance?.hide();
                  event.target.reset();
                  htmx.ajax('GET', window.location.pathname, {
                    target: '#decksGrid',
                    swap: 'innerHTML',
                    select: '#decksGrid'
                  });
                }
              "
            >
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label fw-semibold" for="deckName">Nome do baralho</label>
                  <input class="form-control" type="text" id="deckName" name="name" placeholder="Ex.: Biologia celular" required />
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-semibold" for="deckSubject">Assunto</label>
                  <input class="form-control" type="text" id="deckSubject" name="subject" placeholder="Disciplina" required />
                </div>
              </div>
              <div>
                <label class="form-label fw-semibold" for="deckDescription">Descri√ß√£o</label>
                <textarea class="form-control" id="deckDescription" name="description" rows="3" placeholder="Descreva como pretende utilizar este baralho"></textarea>
              </div>
              <div>
                <label class="form-label fw-semibold" for="deckTags">Tags</label>
                <input class="form-control" type="text" id="deckTags" name="tags" placeholder="Ex.: biologia, gen√©tica" />
                <small class="text-secondary">Separe as tags por v√≠rgula para facilitar a organiza√ß√£o.</small>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" data-loading-button>
                  <span data-loading-label>Salvar baralho</span>
                  <span class="d-none" data-loading-spinner>
                    <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
                    <span class="ms-2">Criando...</span>
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <%- include('../partials/feedback') %>
  <%- include('../partials/scripts') %>
